(function(){angular.module("kisetsuApp",["ngRoute","ordinal"]);function t(t,e){t.when("/",{controller:"homeCtrl",controllerAs:"vm",templateUrl:"home/home.view.html"}).when("/ranking",{title:"Rankings",controller:"rankingCtrl",controllerAs:"vm",templateUrl:"ranking/ranking.view.html"}).otherwise({redirectTo:"/"});e.html5Mode(true)}angular.module("kisetsuApp").config(["$routeProvider","$locationProvider",t]).run(["$rootScope",function(t){t.$on("$routeChangeSuccess",function(e,n,i){t.title=n.$$route.title})}])})();(function(){angular.module("kisetsuApp").controller("rankingCtrl",t);t.$inject=["anidata","ratings","$filter"];function t(t,e,n){var i=this;var a=n("formatRating");var o=n("formatCount");var r=t.getRanking();r.then(function(t){i.mergedAnime=t})}})();(function(){angular.module("kisetsuApp").controller("homeCtrl",t);t.$inject=["anidata","ratings","$window"];function t(t,e,n){if(!Array.prototype.last){Array.prototype.last=function(){return this[this.length-1]}}var i=this;var a=t.getEnv();a.then(function(t){n.document.title=t.data.season.charAt(0).toUpperCase()+t.data.season.slice(1)+" "+t.data.year+" - Kisetsu"});var o=t.getData();o.then(function(t){i.anime=t.data});i.rateAnime=function(t,n,i){$(document).ready(function(){$("body").tooltip({selector:"[data-toggle=tooltip]"})});if(Cookies.get(t.toString())!==undefined){swal({title:"Woah! You've already rated this!",text:"Sorry, please return in "+r(i.time)+" when the next episode airs!",type:"warning",timer:5e3}).then(function(){return})}else{swal({title:"Rating",text:"What did you think about "+n+" this week?",type:"question",confirmButtonText:'Continue <i class="fa fa-arrow-right></i>',showCloseButton:true,showLoaderOnConfirm:true,allowOutsideClick:false,input:"radio",inputOptions:{1:'<i class="material-icons md-48" data-toggle="tooltip" title="Hated it!">sentiment_very_dissatisfied</i>',2:'<i class="material-icons md-48" data-toggle="tooltip" title="It was pretty bad.">sentiment_dissatisfied</i>',3:'<i class="material-icons md-48" data-toggle="tooltip" title="It was okay.">sentiment_neutral</i>',4:'<i class="material-icons md-48" data-toggle="tooltip" title="It was good.">sentiment_satisfied</i>',5:'<i class="material-icons md-48" data-toggle="tooltip" title="Loved it!">sentiment_very_satisfied</i>'},inputValidator:function(t){return new Promise(function(e,n){if(t){e()}else{n("You need to select a rating!")}})},preConfirm:function(n){return new Promise(function(i,a){var o=e.postRating(t,n);o.then(function(t){i(t)})})}}).then(function(t){var e=r(i.time);Cookies.set(t.animeId,t.ratings.last(),{expires:new Date(i.time)});swal({type:"success",text:"Rating submitted! Please come back in "+e+" when the next episode airs!"})})}};var r=function(t){nowTime=moment(Date.now()).format("DD/MM/YYYY HH:mm:ss");nextEpTime=moment(t).format("DD/MM/YYYY HH:mm:ss");var e=moment(nextEpTime,"DD/MM/YYYY HH:mm:ss").diff(moment(nowTime,"DD/MM/YYYY HH:mm:ss"));var n=moment.duration(e);var i=n.days()+" days, "+n.minutes()+" minutes and "+n.seconds()+" seconds";return i}}})();(function(){angular.module("kisetsuApp").controller("navbarCtrl",t);t.$inject=["$location"];function t(t){var e=this;e.isActive=function(e){return e===t.path()}}})();(function(){angular.module("kisetsuApp").factory("anidata",t);t.$inject=["$http","$location"];function t(t,e){var n=function(){return t.get(e.protocol()+"://"+location.host+"/api/envvar").then(function(t){return t})};var i=function(){return t.get(e.protocol()+"://"+location.host+"/api/token").then(function(e){data=e.data.body;year=e.data.year;season=e.data.season;return t({method:"GET",url:"https://anilist.co/api/browse/anime",params:{access_token:data.access_token,season:season,year:year,type:"tv",sort:"title_romaji",full_page:true,airing_data:true}})}).then(function(t){return t})};var a=function(){var n=i();return n.then(function(n){anime=n.data;return t({method:"GET",url:e.protocol()+"://"+location.host+"/api/avg"}).then(function(t){var e;for(e=0;e<t.data.length;e++){t.data[e].id=t.data[e].animeId;delete t.data[e].animeId}mergedAnime=(new jinqJs).from(anime).leftJoin(t.data).on("id").select();mergedAnime.sort(function(t,e){return(parseFloat(t.averageRating)||0)-(parseFloat(e.averageRating)||0)}).reverse();return mergedAnime})})};return{getEnv:n,getData:i,getRanking:a}}})();(function(){angular.module("kisetsuApp").factory("ratings",t);t.$inject=["$http","$location"];function t(t,e){var n=function(n,i){return t({method:"POST",url:e.$$absUrl+"api/rate",transformRequest:function(t){var e=[];for(var n in t)e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{id:parseInt(n),rating:i}}).then(function(t){if(t.status!==200)return[];return t.data},function(t){return[]})};return{postRating:n}}})();(function(){angular.module("kisetsuApp").directive("tooltip",t);function t(){return{restrict:"A",link:function(t,e,n){$(e).hover(function(){$(e).tooltip("show")},function(){$(e).tooltip("hide")})}}}})();(function(){angular.module("kisetsuApp").filter("formatCount",t);function t(){return function(t){if(t===""){return"No Ratings"}else if(t.length===1){return t.length+" Rating"}else{return t.length+" Ratings"}}}})();(function(){angular.module("kisetsuApp").filter("formatRating",t);function t(){return function(t){if(t===""){return"N/A"}else{return Math.round(t*100)/100}}}})();